app-id: me.latinosoft.MultiWall
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: multiwall

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

finish-args:
  # Acceso a X11 y Wayland
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  
  # Acceso a archivos de usuario
  - --filesystem=home
  - --filesystem=xdg-config/multiwall:create
  
  # Acceso a D-Bus para gsettings
  - --socket=session-bus
  - --talk-name=org.gnome.Shell
  - --talk-name=org.freedesktop.portal.Desktop
  
  # CRÍTICO: Permitir comunicación con el host
  - --talk-name=org.freedesktop.Flatpak
  
  # Acceso al sistema de archivos del host para el wallpaper
  # El wallpaper se guardará en ~/.var/app/me.latinosoft.MultiWall/config/
  # que es visible desde el host
  - --persist=.var/app/me.latinosoft.MultiWall
  
  # GPU para preview
  - --device=dri

modules:
  # Dependencias de Python (con acceso a red durante build)
  - name: python3-dependencies
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      - pip3 install --prefix=/app --no-cache-dir Pillow pyyaml python-i18n
    sources: []
    
  # Aplicación principal
  - name: multiwall
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin
      - mkdir -p /app/share/multiwall
      - cp -r multiwall /app/share/multiwall/
      - cp -r fonts /app/share/multiwall/
      - cp main.py /app/share/multiwall/
      - cp requirements.txt /app/share/multiwall/
      - ls -la /app/share/multiwall/fonts/
      
      # Crear script de lanzamiento
      - |
        cat > /app/bin/multiwall << 'EOF'
        #!/bin/bash
        export PYTHONPATH="/app/share/multiwall:$PYTHONPATH"
        cd /app/share/multiwall
        exec python3 main.py "$@"
        EOF
      - chmod +x /app/bin/multiwall
      
      # Instalar archivo desktop
      - install -Dm644 flatpak/me.latinosoft.MultiWall.desktop /app/share/applications/me.latinosoft.MultiWall.desktop
      
      # Instalar icono
      - |
        if [ -f flatpak/icons/me.latinosoft.MultiWall-512.png ]; then
          install -Dm644 flatpak/icons/me.latinosoft.MultiWall-128.png /app/share/icons/hicolor/128x128/apps/me.latinosoft.MultiWall.png
          install -Dm644 flatpak/icons/me.latinosoft.MultiWall-256.png /app/share/icons/hicolor/256x256/apps/me.latinosoft.MultiWall.png
          install -Dm644 flatpak/icons/me.latinosoft.MultiWall-512.png /app/share/icons/hicolor/512x512/apps/me.latinosoft.MultiWall.png
        else
          install -Dm644 flatpak/me.latinosoft.MultiWall.png /app/share/icons/hicolor/512x512/apps/me.latinosoft.MultiWall.png
        fi
      
      # Instalar metainfo
      - install -Dm644 flatpak/me.latinosoft.MultiWall.metainfo.xml /app/share/metainfo/me.latinosoft.MultiWall.metainfo.xml
    
    sources:
      - type: dir
        path: ..